---
import Layout from '../../layouts/Layout.astro';
---
<Layout>
	<main class="min-h-screen p-6" x-data="dashboardData()">
        <div x-show="loading" class="flex items-center justify-center min-h-[50vh]">
            <div class="text-center"><div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div><p class="text-gray-500 font-medium">Cargando datos...</p></div>
        </div>
        <div x-show="!loading && !authorized" class="flex items-center justify-center min-h-[50vh]">
            <div class="text-center bg-white p-10 rounded-3xl shadow-xl border"><p class="text-xl font-bold text-red-600 mb-4">⚠️ No autorizado</p><a href="/" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition">Ir al inicio</a></div>
        </div>
        <div x-show="!loading && authorized" x-cloak>
            <div class="max-w-7xl mx-auto mb-8 flex justify-between items-end">
                <div><h1 class="text-3xl font-extrabold text-blue-700">Panel de Administrador</h1><p class="text-gray-500 mt-1">Resumen de inspecciones y evaluaciones de riesgo</p></div>
                <a href="/api/logout.php" class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-red-600 transition text-sm">Cerrar Sesión</a>
            </div>
            <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-blue-600" x-text="stats.total"></p><p class="text-xs text-gray-500 mt-1">Total</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-blue-500" x-text="stats.avgScore"></p><p class="text-xs text-gray-500 mt-1">Puntaje Prom.</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-green-600" x-text="stats.bajo"></p><p class="text-xs text-gray-500 mt-1">Bajo</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-yellow-600" x-text="stats.moderado"></p><p class="text-xs text-gray-500 mt-1">Moderado</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-orange-600" x-text="stats.alto"></p><p class="text-xs text-gray-500 mt-1">Alto</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-red-600" x-text="stats.critico"></p><p class="text-xs text-gray-500 mt-1">Crítico</p></div>
            </div>
            <div class="max-w-7xl mx-auto mb-6"><input type="text" x-model="search" placeholder="Buscar por inspector, provincia o país..." class="w-full md:w-96 border border-gray-300 rounded-xl px-4 py-2 shadow-sm focus:ring focus:ring-blue-200 outline-none"/></div>
            <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">#</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">Inspector</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">Tipo</th>
                                <th class="px-3 py-3 text-center font-semibold text-gray-600">Plantas</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">Zona</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">País</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">Provincia</th>
                                <th class="px-3 py-3 text-center font-semibold text-gray-600">Total</th>
                                <th class="px-3 py-3 text-center font-semibold text-gray-600">Nivel</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">Fecha</th>
                                <th class="px-3 py-3 text-center font-semibold text-gray-600">Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(r, i) in filtered()" :key="i">
                                <tr>
                                    <td colspan="11" class="p-0">
                                        <div class="flex items-center border-b hover:bg-blue-50 transition cursor-pointer" @click="exp = exp===i ? null : i">
                                            <div class="px-3 py-3 text-gray-400 w-[40px]" x-text="i+1"></div>
                                            <div class="px-3 py-3 font-medium flex-1" x-text="r.inspector_nombre||'-'"></div>
                                            <div class="px-3 py-3 flex-1" x-text="r.tipo_vivienda||'-'"></div>
                                            <div class="px-3 py-3 text-center w-[60px]" x-text="r.plantas||'-'"></div>
                                            <div class="px-3 py-3 w-[80px]" x-text="r.zona_construccion||'-'"></div>
                                            <div class="px-3 py-3 w-[80px]" x-text="r.pais||'-'"></div>
                                            <div class="px-3 py-3 w-[100px]" x-text="r.provincia||'-'"></div>
                                            <div class="px-3 py-3 text-center font-bold w-[60px]" x-text="r.score_total"></div>
                                            <div class="px-3 py-3 text-center w-[100px]"><span class="px-2 py-1 rounded-lg text-xs font-bold" :class="lvlClass(r.nivel_riesgo)" x-text="r.nivel_riesgo"></span></div>
                                            <div class="px-3 py-3 text-gray-400 text-xs w-[80px]" x-text="r.created_at?new Date(r.created_at).toLocaleDateString('es'):r.fecha||'-'"></div>
                                            <div class="px-3 py-3 text-center text-blue-500 w-[40px]"><span x-text="exp===i?'▲':'▼'"></span></div>
                                        </div>
                                        <div x-show="exp===i" x-transition class="bg-blue-50 px-6 py-4 border-b">
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Región</p><p class="font-medium" x-text="r.region||'-'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Estudios</p><p class="font-medium" x-text="r.grado_estudios||'-'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Eléctrico</p><p class="font-bold" x-text="r.score_electrico+'/15'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Incendio/Gas</p><p class="font-bold" x-text="r.score_incendio+'/15'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Caídas</p><p class="font-bold" x-text="r.score_caidas+'/15'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Humedad</p><p class="font-bold" x-text="r.score_humedad+'/15'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Estructural</p><p class="font-bold" x-text="r.score_estructural+'/15'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Salud</p><p class="font-bold" x-text="r.score_salud+'/15'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Infantil</p><p class="font-bold" x-text="r.score_infantil+'/15'"></p></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <p x-show="data.length===0&&!loading" class="text-center py-10 text-gray-400">No hay inspecciones registradas aún.</p>
            </div>
        </div>
	</main>
</Layout>
<script>
import Alpine from 'alpinejs';
window.dashboardData = function() {
    return {
        loading: true, authorized: false, search: '', exp: null,
        stats: {total:0,bajo:0,moderado:0,alto:0,critico:0,avgScore:0}, data: [],
        async init() {
            if (!document.cookie.includes('admin_auth=true')) { this.loading=false; return; }
            try {
                const res = await fetch('/api/get_inspecciones.php');
                if (res.status===401) { this.loading=false; return; }
                const d = await res.json(); this.stats=d.stats; this.data=d.inspecciones; this.authorized=true;
            } catch(e) { console.error(e); }
            this.loading=false;
        },
        filtered() { if(!this.search) return this.data; const s=this.search.toLowerCase(); return this.data.filter(r=>`${r.inspector_nombre||''} ${r.provincia||''} ${r.pais||''}`.toLowerCase().includes(s)); },
        lvlClass(n) { return n==='Bajo'?'bg-green-100 text-green-700':n==='Moderado'?'bg-yellow-100 text-yellow-700':n==='Alto'?'bg-orange-100 text-orange-700':'bg-red-100 text-red-700'; }
    };
};
window.Alpine = Alpine; Alpine.start();
</script>
<style>[x-cloak] { display: none !important; }</style>
