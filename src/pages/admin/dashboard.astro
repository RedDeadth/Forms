---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import { pool } from '../../db.js';

// Proteger ruta para Admin
if (!Astro.cookies.has('admin_auth')) {
    return Astro.redirect('/');
}

// Obtener datos
let inspecciones = [];
let stats = {
    total: 0,
    conDanos: 0,
    licenciasNo: 0,
    sismoAltoCritico: 0
};

try {
    const [rows] = await pool.query('SELECT * FROM inspecciones ORDER BY created_at DESC');
    inspecciones = rows as any[];
    
    // Calcular estadisticas
    stats.total = inspecciones.length;
    stats.conDanos = inspecciones.filter(i => i.danos_vivienda === 'si').length;
    stats.licenciasNo = inspecciones.filter(i => i.tiene_licencia === 'no').length;
    stats.sismoAltoCritico = inspecciones.filter(i => i.severidad_sismo === 'alto' || i.severidad_sismo === 'critico').length;

} catch (e) {
    console.error("Error cargando inspecciones:", e);
}

// Helper para fecha
const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('es-ES', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    });
};
---

<Layout>
	<main class="min-h-screen p-6" x-data="{ search: '' }">
        
        <!-- Header -->
        <div class="max-w-7xl mx-auto mb-8 flex justify-between items-end">
            <div>
		        <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">Panel Administrativo</h1>
                <p class="text-gray-500">Módulo de control de inspecciones de inmuebles</p>
            </div>
            <a href="/api/logout" class="bg-red-100 text-red-700 hover:bg-red-200 px-6 py-2 rounded-xl font-bold transition">Cerrar Sesión</a>
        </div>

        <!-- Estadisticas -->
        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <p class="text-sm font-semibold text-gray-500 mb-1">Total Inspecciones</p>
                <p class="text-3xl font-bold text-blue-600">{stats.total}</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <p class="text-sm font-semibold text-gray-500 mb-1">Inmuebles con Daños</p>
                <p class="text-3xl font-bold text-orange-500">{stats.conDanos}</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <p class="text-sm font-semibold text-gray-500 mb-1">Sin Licencia</p>
                <p class="text-3xl font-bold text-red-500">{stats.licenciasNo}</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <p class="text-sm font-semibold text-gray-500 mb-1">Sismos (Alto/Crítico)</p>
                <p class="text-3xl font-bold text-red-700">{stats.sismoAltoCritico}</p>
            </div>
        </div>

        <!-- Tabla Expandible -->
        <div class="max-w-7xl mx-auto bg-white rounded-3xl shadow-md border border-gray-200 overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">Registros Recientes</h2>
            </div>
            
            <div class="divide-y divide-gray-100">
                {inspecciones.length === 0 ? (
                    <div class="p-10 text-center text-gray-500">No hay inspecciones registradas aún.</div>
                ) : (
                    inspecciones.map((insp) => (
                        <div x-data="{ expanded: false }" class="hover:bg-gray-50 transition-colors">
                            <!-- Fila Principal (Clickable) -->
                            <div @click="expanded = !expanded" class="p-6 cursor-pointer flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="flex-1 grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div>
                                        <p class="text-xs text-gray-400 font-semibold mb-1">INSPECTOR</p>
                                        <p class="font-bold text-gray-800">{insp.inspector_nombre}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400 font-semibold mb-1">UBICACIÓN</p>
                                        <p class="text-gray-700">{insp.pais} / {insp.sector || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400 font-semibold mb-1">INMUEBLE</p>
                                        <p class="text-gray-700">{insp.tipo_vivienda} ({insp.pisos} pisos)</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400 font-semibold mb-1">FECHA</p>
                                        <p class="text-gray-700">{formatDate(insp.created_at)}</p>
                                    </div>
                                </div>
                                <div class="text-blue-500">
                                    <svg class="w-6 h-6 transform transition-transform" :class="{'rotate-180': expanded}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>

                            <!-- Panel Expandido (Detalles) -->
                            <div x-show="expanded" x-collapse x-cloak class="bg-blue-50/50 border-t border-blue-100 p-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                    
                                    <!-- Columna 1 -->
                                    <div class="space-y-3">
                                        <h3 class="font-bold text-blue-900 border-b border-blue-200 pb-2">1. Datos Generales</h3>
                                        <p><span class="text-sm text-gray-500 font-semibold">Área Const:</span> {insp.area_construccion} m2</p>
                                        <p><span class="text-sm text-gray-500 font-semibold">Región/Prov:</span> {insp.region || '-'} / {insp.provincia || '-'}</p>
                                        <p><span class="text-sm text-gray-500 font-semibold">Conoce Edad:</span> <span class="uppercase text-xs font-bold px-2 py-1 rounded bg-gray-200">{insp.conoce_edad || '-'}</span></p>
                                    </div>

                                    <!-- Columna 2 -->
                                    <div class="space-y-3">
                                        <h3 class="font-bold text-blue-900 border-b border-blue-200 pb-2">2. Construcción</h3>
                                        <p><span class="text-sm text-gray-500 font-semibold">Licencia:</span> 
                                            <span class={`uppercase text-xs font-bold px-2 py-1 rounded ${insp.tiene_licencia === 'si' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                {insp.tiene_licencia || '-'}
                                            </span>
                                        </p>
                                        {insp.tiene_licencia === 'si' ? (
                                            <p><span class="text-sm text-gray-500 font-semibold">Num. Licencia:</span> {insp.numero_licencia || '-'}</p>
                                        ) : (
                                            <>
                                                <p><span class="text-sm text-gray-500 font-semibold">Mano Obra:</span> {insp.pago_mano_obra || '-'}</p>
                                                <p><span class="text-sm text-gray-500 font-semibold">Planos:</span> {insp.tiene_planos || '-'}</p>
                                                <p><span class="text-sm text-gray-500 font-semibold">Asistencia:</span> {insp.cuenta_asistencia || '-'}</p>
                                            </>
                                        )}
                                    </div>

                                    <!-- Columna 3 -->
                                    <div class="space-y-3">
                                        <h3 class="font-bold text-blue-900 border-b border-blue-200 pb-2">3. Daños y Sismos</h3>
                                        <p><span class="text-sm text-gray-500 font-semibold">Presenta Daños:</span> 
                                            <span class={`uppercase text-xs font-bold px-2 py-1 rounded ${insp.danos_vivienda === 'si' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}`}>
                                                {insp.danos_vivienda || '-'}
                                            </span>
                                        </p>
                                        {insp.danos_vivienda === 'si' && (
                                            <>
                                                <p><span class="text-sm text-gray-500 font-semibold">Ubicación:</span> {insp.ubicacion_dano}</p>
                                                <p><span class="text-sm text-gray-500 font-semibold">Tipo Daño:</span> {insp.tipo_dano}</p>
                                            </>
                                        )}
                                        <p class="mt-4"><span class="text-sm text-gray-500 font-semibold">Severidad Sismo:</span> 
                                            <span class="uppercase text-xs font-bold px-2 py-1 rounded bg-gray-200">{insp.severidad_sismo || '-'}</span>
                                        </p>
                                    </div>

                                </div>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </div>

	</main>
</Layout>

<script>
	import Alpine from 'alpinejs';
	import collapse from '@alpinejs/collapse';
	Alpine.plugin(collapse);
	window.Alpine = Alpine;
	Alpine.start();
</script>

<style>
	[x-cloak] { display: none !important; }
</style>
