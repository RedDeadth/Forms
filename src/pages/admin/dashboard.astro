---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import { pool } from '../../db.js';

if (!Astro.cookies.has('admin_auth')) {
    return Astro.redirect('/');
}

let stats = { total: 0, bajo: 0, moderado: 0, alto: 0, critico: 0, avgScore: 0 };
let inspecciones = [];

try {
    const [rows] = await pool.query('SELECT * FROM inspecciones ORDER BY created_at DESC LIMIT 50');
    inspecciones = rows;
    stats.total = rows.length;
    stats.bajo = rows.filter(r => r.nivel_riesgo === 'Bajo').length;
    stats.moderado = rows.filter(r => r.nivel_riesgo === 'Moderado').length;
    stats.alto = rows.filter(r => r.nivel_riesgo === 'Alto').length;
    stats.critico = rows.filter(r => r.nivel_riesgo === 'Crítico').length;
    stats.avgScore = rows.length ? Math.round(rows.reduce((a, r) => a + (r.score_total || 0), 0) / rows.length) : 0;
} catch (e) {
    console.error('Dashboard DB error:', e);
}
---

<Layout>
	<main class="min-h-screen p-6" x-data="{ search: '' }">
        
        <div class="max-w-7xl mx-auto mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-700">Panel de Administrador</h1>
                <p class="text-gray-500 mt-1">Resumen de inspecciones y evaluaciones de riesgo</p>
            </div>
            <a href="/api/logout" class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-red-600 transition text-sm">Cerrar Sesión</a>
        </div>

        <!-- Stats Cards -->
        <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
            <div class="bg-white rounded-2xl p-5 shadow-md border text-center">
                <p class="text-3xl font-black text-blue-600">{stats.total}</p>
                <p class="text-xs text-gray-500 mt-1">Total</p>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-md border text-center">
                <p class="text-3xl font-black text-blue-500">{stats.avgScore}</p>
                <p class="text-xs text-gray-500 mt-1">Puntaje Prom.</p>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-md border text-center">
                <p class="text-3xl font-black text-green-600">{stats.bajo}</p>
                <p class="text-xs text-gray-500 mt-1">Bajo</p>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-md border text-center">
                <p class="text-3xl font-black text-yellow-600">{stats.moderado}</p>
                <p class="text-xs text-gray-500 mt-1">Moderado</p>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-md border text-center">
                <p class="text-3xl font-black text-orange-600">{stats.alto}</p>
                <p class="text-xs text-gray-500 mt-1">Alto</p>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-md border text-center">
                <p class="text-3xl font-black text-red-600">{stats.critico}</p>
                <p class="text-xs text-gray-500 mt-1">Crítico</p>
            </div>
        </div>

        <!-- Search -->
        <div class="max-w-7xl mx-auto mb-6">
            <input type="text" x-model="search" placeholder="Buscar por inspector o provincia..." class="w-full md:w-96 border border-gray-300 rounded-xl px-4 py-2 shadow-sm focus:ring focus:ring-blue-200 outline-none"/>
        </div>

        <!-- Table -->
        <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">#</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Inspector</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Provincia</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Eléct.</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Incen.</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Caídas</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Humed.</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Estruc.</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Salud</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Infant.</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Total</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Nivel</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        {inspecciones.map((r, i) => {
                            const levelClass = r.nivel_riesgo === 'Bajo' ? 'bg-green-100 text-green-700' 
                                : r.nivel_riesgo === 'Moderado' ? 'bg-yellow-100 text-yellow-700'
                                : r.nivel_riesgo === 'Alto' ? 'bg-orange-100 text-orange-700'
                                : 'bg-red-100 text-red-700';
                            return (
                                <tr class="border-b hover:bg-blue-50 transition"
                                    x-show={`'${(r.inspector_nombre||'').toLowerCase()}'.includes(search.toLowerCase()) || '${(r.provincia||'').toLowerCase()}'.includes(search.toLowerCase()) || search===''`}>
                                    <td class="px-4 py-3 text-gray-400">{i + 1}</td>
                                    <td class="px-4 py-3 font-medium">{r.inspector_nombre}</td>
                                    <td class="px-4 py-3">{r.provincia || '-'}</td>
                                    <td class="px-4 py-3 text-center">{r.score_electrico}</td>
                                    <td class="px-4 py-3 text-center">{r.score_incendio}</td>
                                    <td class="px-4 py-3 text-center">{r.score_caidas}</td>
                                    <td class="px-4 py-3 text-center">{r.score_humedad}</td>
                                    <td class="px-4 py-3 text-center">{r.score_estructural}</td>
                                    <td class="px-4 py-3 text-center">{r.score_salud}</td>
                                    <td class="px-4 py-3 text-center">{r.score_infantil}</td>
                                    <td class="px-4 py-3 text-center font-bold">{r.score_total}</td>
                                    <td class="px-4 py-3 text-center"><span class={`px-2 py-1 rounded-lg text-xs font-bold ${levelClass}`}>{r.nivel_riesgo}</span></td>
                                    <td class="px-4 py-3 text-gray-400 text-xs">{new Date(r.created_at).toLocaleDateString('es')}</td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
            {inspecciones.length === 0 && <p class="text-center py-10 text-gray-400">No hay inspecciones registradas aún.</p>}
        </div>
	</main>
</Layout>

<script>
import Alpine from 'alpinejs';
window.Alpine = Alpine;
Alpine.start();
</script>
