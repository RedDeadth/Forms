---
import Layout from '../../layouts/Layout.astro';
---
<Layout>
	<main class="min-h-screen p-6" x-data="dashboardData()">
        <div x-show="loading" class="flex items-center justify-center min-h-[50vh]">
            <div class="text-center"><div class="w-12 h-12 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mx-auto mb-4"></div><p class="text-gray-500 font-medium">Cargando datos...</p></div>
        </div>
        <div x-show="!loading && !authorized" class="flex items-center justify-center min-h-[50vh]">
            <div class="text-center bg-white p-10 rounded-3xl shadow-xl border"><p class="text-xl font-bold text-red-600 mb-4">‚ö†Ô∏è No autorizado</p><a href="/" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-700 transition">Ir al inicio</a></div>
        </div>
        <div x-show="!loading && authorized" x-cloak>
            <div class="max-w-7xl mx-auto mb-8 flex justify-between items-end">
                <div><h1 class="text-3xl font-extrabold text-emerald-700">Panel de Administrador</h1><p class="text-gray-500 mt-1">Resumen de evaluaciones KPI - Comunicaci√≥n del Docente</p></div>
                <a href="/api/logout.php" class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-red-600 transition text-sm">Cerrar Sesi√≥n</a>
            </div>
            <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-emerald-600" x-text="stats.total"></p><p class="text-xs text-gray-500 mt-1">Total Respuestas</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-green-600">‚úì</p><p class="text-xs text-gray-500 mt-1">Base de Datos Activa</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-blue-600">üìã</p><p class="text-xs text-gray-500 mt-1">Encuestas Pendientes</p></div>
            </div>
            <div class="max-w-7xl mx-auto mb-6"><input type="text" x-model="search" placeholder="Buscar por nombre del encuestado..." class="w-full md:w-96 border border-gray-300 rounded-xl px-4 py-2 shadow-sm focus:ring focus:ring-emerald-200 outline-none"/></div>
            <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm whitespace-nowrap">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">N¬∞</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Instituci√≥n</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Tipo Gesti√≥n</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Pa√≠s</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Regi√≥n</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Provincia</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Programa</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Cargo</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">A√±os</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Profesi√≥n</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Puntaje</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Nivel Docente</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-600">Fecha Reg.</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(r, i) in filtered()" :key="i">
                                <tr class="border-b hover:bg-emerald-50 transition">
                                    <td class="px-4 py-3 text-gray-400" x-text="i+1"></td>
                                    <td class="px-4 py-3 font-medium text-gray-800" x-text="r.institucion_educativa||'-'"></td>
                                    <td class="px-4 py-3 text-gray-600" x-text="r.tipo_gestion||'-'"></td>
                                    <td class="px-4 py-3 text-gray-600" x-text="r.pais||'-'"></td>
                                    <td class="px-4 py-3 text-gray-600" x-text="r.region||'-'"></td>
                                    <td class="px-4 py-3 text-gray-600" x-text="r.provincia||'-'"></td>
                                    <td class="px-4 py-3 text-gray-600" x-text="r.programa_estudios||'-'"></td>
                                    <td class="px-4 py-3 text-gray-600" x-text="r.cargo_institucion||'-'"></td>
                                    <td class="px-4 py-3 text-gray-600 text-center" x-text="r.anios_ensenando||'-'"></td>
                                    <td class="px-4 py-3 text-gray-600" x-text="r.profesion||'-'"></td>
                                    <td class="px-4 py-3 font-bold text-emerald-600" x-text="r.score_total+'/105'"></td>
                                    <td class="px-4 py-3 text-xs font-semibold text-gray-700" x-text="r.nivel_docente||'-'"></td>
                                    <td class="px-4 py-3 text-gray-400 text-xs" x-text="r.created_at?new Date(r.created_at).toLocaleDateString('es'):'-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <p x-show="data.length===0&&!loading" class="text-center py-10 text-gray-400">No hay evaluaciones registradas a√∫n.</p>
            </div>
        </div>
	</main>
</Layout>
<script>
import Alpine from 'alpinejs';
window.dashboardData = function() {
    return {
        loading: true, authorized: false, search: '', data: [],
        stats: {total:0},
        async init() {
            if (!document.cookie.includes('admin_auth=true')) { this.loading=false; return; }
            try {
                const res = await fetch('/api/get_evaluaciones.php');
                if (res.status===401) { this.loading=false; return; }
                const d = await res.json(); this.stats=d.stats; this.data=d.evaluaciones; this.authorized=true;
            } catch(e) { console.error(e); }
            this.loading=false;
        },
        filtered() { if(!this.search) return this.data; const s=this.search.toLowerCase(); return this.data.filter(r=>`${r.encuestado_nombre||''}`.toLowerCase().includes(s)); }
    };
};
window.Alpine = Alpine; Alpine.start();
</script>
<style>[x-cloak] { display: none !important; }</style>
