---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import { pool } from '../../db.js';

if (!Astro.cookies.has('admin_auth')) {
    return Astro.redirect('/');
}

let respuestas = [];

try {
    const [rows] = await pool.query('SELECT * FROM evaluaciones ORDER BY created_at DESC LIMIT 50');
    respuestas = rows;
} catch (e) {
    console.error('Dashboard DB error:', e);
}
---

<Layout>
	<main class="min-h-screen p-6" x-data="{ search: '' }">
        
        <div class="max-w-7xl mx-auto mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-extrabold text-emerald-700">Panel de Administrador</h1>
                <p class="text-gray-500 mt-1">Resumen de evaluaciones KPI - Comunicaci√≥n del Docente</p>
            </div>
            <a href="/api/logout" class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-red-600 transition text-sm">Cerrar Sesi√≥n</a>
        </div>

        <!-- Stats -->
        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-2xl p-5 shadow-md border text-center">
                <p class="text-3xl font-black text-emerald-600">{respuestas.length}</p>
                <p class="text-xs text-gray-500 mt-1">Total Respuestas</p>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-md border text-center">
                <p class="text-3xl font-black text-green-600">‚úì</p>
                <p class="text-xs text-gray-500 mt-1">Base de Datos Activa</p>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-md border text-center">
                <p class="text-3xl font-black text-blue-600">üìã</p>
                <p class="text-xs text-gray-500 mt-1">Encuestas Pendientes</p>
            </div>
        </div>

        <!-- Search -->
        <div class="max-w-7xl mx-auto mb-6">
            <input type="text" x-model="search" placeholder="Buscar por nombre del encuestado..." class="w-full md:w-96 border border-gray-300 rounded-xl px-4 py-2 shadow-sm focus:ring focus:ring-emerald-200 outline-none"/>
        </div>

        <!-- Table -->
        <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm whitespace-nowrap">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">N¬∞</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Instituci√≥n</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Tipo Gesti√≥n</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Pa√≠s</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Regi√≥n</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Provincia</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Programa</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Cargo</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">A√±os</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Profesi√≥n</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Puntaje</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Nivel Docente</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Fecha Reg.</th>
                        </tr>
                    </thead>
                    <tbody>
                        {respuestas.map((r, i) => {
                            const searchStr = `${(r.encuestado_nombre||'').toLowerCase()}`;
                            return (
                                <tr class="border-b hover:bg-emerald-50 transition"
                                    x-show={`'${searchStr}'.includes(search.toLowerCase()) || search===''`}>
                                    <td class="px-4 py-3 text-gray-400">{i + 1}</td>
                                    <td class="px-4 py-3 font-medium text-gray-800">{r.institucion_educativa}</td>
                                    <td class="px-4 py-3 text-gray-600">{r.tipo_gestion}</td>
                                    <td class="px-4 py-3 text-gray-600">{r.pais}</td>
                                    <td class="px-4 py-3 text-gray-600">{r.region || '-'}</td>
                                    <td class="px-4 py-3 text-gray-600">{r.provincia || '-'}</td>
                                    <td class="px-4 py-3 text-gray-600">{r.programa_estudios}</td>
                                    <td class="px-4 py-3 text-gray-600">{r.cargo_institucion}</td>
                                    <td class="px-4 py-3 text-gray-600 text-center">{r.anios_ensenando}</td>
                                    <td class="px-4 py-3 text-gray-600">{r.profesion}</td>
                                    <td class="px-4 py-3 font-bold text-emerald-600">{r.score_total}/105</td>
                                    <td class="px-4 py-3 text-xs font-semibold text-gray-700">{r.nivel_docente}</td>
                                    <td class="px-4 py-3 text-gray-400 text-xs">{new Date(r.created_at).toLocaleDateString('es')}</td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
            {respuestas.length === 0 && <p class="text-center py-10 text-gray-400">No hay evaluaciones registradas a√∫n.</p>}
        </div>
	</main>
</Layout>

<script>
import Alpine from 'alpinejs';
window.Alpine = Alpine;
Alpine.start();
</script>
