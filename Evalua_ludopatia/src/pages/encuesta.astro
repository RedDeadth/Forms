---
export const prerender = false;
import Layout from '../layouts/Layout.astro';
if (!Astro.cookies.has('user_name')) { return Astro.redirect('/'); }
const userName = Astro.cookies.get('user_name')?.value;
---
<Layout>
	<main class="max-w-4xl mx-auto py-10 px-6">
		<div class="flex justify-between items-center mb-10">
			<h1 class="text-3xl font-extrabold text-purple-700 tracking-tight">Evaluación de Ludopatía</h1>
			<span class="text-gray-600 bg-gray-100 px-4 py-2 rounded-full text-sm font-semibold">Bienvenido {userName}</span>
			<a href="/api/logout" class="text-white bg-red-500 px-4 py-2 rounded-full text-sm font-semibold">Cerrar Sesión</a>
		</div>
		
		<form id="ludopatia-form" action="/api/submit" method="POST" class="bg-white shadow-2xl rounded-3xl p-8 border border-gray-100" x-data="formData()" @submit.prevent="submitForm()">
			<input type="hidden" name="evaluador_nombre" value={userName} />

			<!-- ===== SECTION 1: Evaluador ===== -->
			<div class="mb-10 border-b pb-8">
				<h2 class="section-title">1. Evaluador</h2>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					<div>
						<label class="field-label">1.1 Fecha</label>
						<input type="text" name="fecha" :value="new Date().toLocaleDateString('es-PE')" readonly class="cs-input bg-gray-50 text-gray-500 cursor-not-allowed"/>
					</div>
					<div>
						<label class="field-label">1.2 País</label>
						<input type="text" name="pais" x-model="pais" required class="cs-input" placeholder="Ej: Perú"/>
					</div>
					<div :class="pais.toLowerCase().trim()!=='perú'&&pais.toLowerCase().trim()!=='peru'?'opacity-50':''">
						<label class="field-label">1.3 Región</label>
						<input type="text" name="region" class="cs-input" :required="pais.toLowerCase().trim()==='perú'||pais.toLowerCase().trim()==='peru'"/>
					</div>
					<div :class="pais.toLowerCase().trim()!=='perú'&&pais.toLowerCase().trim()!=='peru'?'opacity-50':''">
						<label class="field-label">1.4 Provincia</label>
						<input type="text" name="provincia" class="cs-input" :required="pais.toLowerCase().trim()==='perú'||pais.toLowerCase().trim()==='peru'"/>
					</div>
					<div>
						<label class="field-label">1.5 Grado de estudios</label>
						<input type="hidden" name="grado_estudios_evaluador" x-model="gradoEstudios" />
						<div class="relative">
							<button type="button" @click="toggleDd('gradoEstudios')" class="cs-trigger" :class="openDd==='gradoEstudios'&&'cs-trigger-active'">
								<span x-text="gradoEstudiosLabel" :class="!gradoEstudios&&'text-gray-400'"></span>
								<svg class="cs-arrow" :class="openDd==='gradoEstudios'&&'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
							</button>
							<div class="cs-list" :class="openDd==='gradoEstudios'?'cs-list-open':''">
								<template x-for="o in [{v:'Inicial'},{v:'Primaria'},{v:'Secundaria'},{v:'Superior'}]"><div class="cs-option" @click="sel('gradoEstudios',o.v,o.v)" x-text="o.v"></div></template>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- ===== SECTION 2: Evaluado ===== -->
			<div class="mb-10 border-b pb-8">
				<h2 class="section-title">2. Evaluado</h2>
				<p class="text-sm text-gray-500 mb-6">Una vez registrado el evaluador, registre a quien quiere evaluar.</p>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					<div>
						<label class="field-label">2.1 Sexo</label>
						<input type="hidden" name="sexo" x-model="sexo" />
						<div class="relative">
							<button type="button" @click="toggleDd('sexo')" class="cs-trigger" :class="openDd==='sexo'&&'cs-trigger-active'">
								<span x-text="sexoLabel" :class="!sexo&&'text-gray-400'"></span>
								<svg class="cs-arrow" :class="openDd==='sexo'&&'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
							</button>
							<div class="cs-list" :class="openDd==='sexo'?'cs-list-open':''">
								<template x-for="o in [{v:'Masculino'},{v:'Femenino'}]"><div class="cs-option" @click="sel('sexo',o.v,o.v)" x-text="o.v"></div></template>
							</div>
						</div>
					</div>
					<div>
						<label class="field-label">2.2 Edad</label>
						<input type="number" name="edad" min="1" max="120" required class="cs-input" placeholder="Ej: 25"/>
					</div>
					<div>
						<label class="field-label">2.3 Grado de instrucción concluida</label>
						<input type="hidden" name="grado_instruccion" x-model="gradoInstruccion" />
						<div class="relative">
							<button type="button" @click="toggleDd('gradoInstruccion')" class="cs-trigger" :class="openDd==='gradoInstruccion'&&'cs-trigger-active'">
								<span x-text="gradoInstruccionLabel" :class="!gradoInstruccion&&'text-gray-400'"></span>
								<svg class="cs-arrow" :class="openDd==='gradoInstruccion'&&'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
							</button>
							<div class="cs-list" :class="openDd==='gradoInstruccion'?'cs-list-open':''">
								<template x-for="o in [{v:'Inicial'},{v:'Primaria'},{v:'Superior Técnica'},{v:'Superior Universitaria'},{v:'Ninguna'}]"><div class="cs-option" @click="sel('gradoInstruccion',o.v,o.v)" x-text="o.v"></div></template>
							</div>
						</div>
					</div>
					<div>
						<label class="field-label">2.4 Tipo de trabajo</label>
						<input type="hidden" name="tipo_trabajo" x-model="tipoTrabajo" />
						<div class="relative">
							<button type="button" @click="toggleDd('tipoTrabajo')" class="cs-trigger" :class="openDd==='tipoTrabajo'&&'cs-trigger-active'">
								<span x-text="tipoTrabajoLabel" :class="!tipoTrabajo&&'text-gray-400'"></span>
								<svg class="cs-arrow" :class="openDd==='tipoTrabajo'&&'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
							</button>
							<div class="cs-list" :class="openDd==='tipoTrabajo'?'cs-list-open':''">
								<template x-for="o in [{v:'Dependiente'},{v:'Independiente'},{v:'No trabaja (herencias)'},{v:'Ama de casa'},{v:'Estudiante escolar'},{v:'Estudiante nivel superior'},{v:'Desempleado'},{v:'Otros'}]"><div class="cs-option" @click="sel('tipoTrabajo',o.v,o.v)" x-text="o.v"></div></template>
							</div>
						</div>
					</div>
					<div class="md:col-span-2">
						<label class="field-label">2.5 Nivel socioeconómico</label>
						<input type="hidden" name="nivel_socioeconomico" x-model="nivelSocio" />
						<div class="relative">
							<button type="button" @click="toggleDd('nivelSocio')" class="cs-trigger" :class="openDd==='nivelSocio'&&'cs-trigger-active'">
								<span x-text="nivelSocioLabel" :class="!nivelSocio&&'text-gray-400'"></span>
								<svg class="cs-arrow" :class="openDd==='nivelSocio'&&'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
							</button>
							<div class="cs-list" :class="openDd==='nivelSocio'?'cs-list-open':''">
								<template x-for="o in [{v:'A',l:'A (Alto)'},{v:'B',l:'B'},{v:'C',l:'C'},{v:'D',l:'D'},{v:'E',l:'E (Extrema pobreza)'}]"><div class="cs-option" @click="sel('nivelSocio',o.v,o.l)" x-text="o.l"></div></template>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- ===== SECTION 3: Cuestionario ===== -->
			<div class="mb-10 border-b pb-8">
				<h2 class="section-title">3. Cuestionario de Ludopatía</h2>
				<p class="text-sm text-gray-500 mb-6">Responde pensando en los <strong>últimos 12 meses</strong>. Escala: <strong>Nunca</strong> · <strong>A veces</strong> · <strong>Con frecuencia</strong> · <strong>Casi siempre</strong></p>

				<template x-for="(sec, si) in sections" :key="si">
					<div class="mb-8">
						<div class="flex items-center gap-3 mb-4">
							<h3 class="text-lg font-bold text-gray-800" x-text="'3.'+(si+1)+' '+sec.title"></h3>
							<span class="text-xs font-bold px-3 py-1 rounded-full" :class="sectionScore(si)>sec.max*0.5?'bg-red-100 text-red-700':'bg-green-100 text-green-700'" x-text="'Puntaje: '+sectionScore(si)+'/'+sec.max"></span>
						</div>
						<div class="space-y-3">
							<template x-for="(q, qi) in sec.questions" :key="qi">
								<div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 flex flex-col md:flex-row md:items-center gap-3">
									<p class="flex-1 text-sm font-medium text-gray-700" x-text="'3.'+(si+1)+'.'+(qi+1)+' '+q"></p>
									<div class="relative shrink-0 w-52">
										<button type="button" @click="openRiskDd = openRiskDd===si+'_'+qi ? null : si+'_'+qi" class="cs-trigger text-sm" :class="openRiskDd===si+'_'+qi&&'cs-trigger-active'">
											<span class="truncate" x-text="answers[si][qi]<0?'Seleccione...':scaleOptions[answers[si][qi]].l" :class="answers[si][qi]<0?'text-gray-400':scaleLabelColors[answers[si][qi]]"></span>
											<svg class="cs-arrow" :class="openRiskDd===si+'_'+qi&&'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
										</button>
										<div class="cs-list" :class="openRiskDd===si+'_'+qi?'cs-list-open':''">
											<template x-for="opt in scaleOptions" :key="opt.v">
												<div class="cs-option flex items-center gap-2" @click="answers[si][qi]=opt.v; openRiskDd=null">
													<span class="w-2 h-2 rounded-full shrink-0" :class="scaleDotColors[opt.v]"></span>
													<span x-text="opt.l"></span>
												</div>
											</template>
										</div>
									</div>
								</div>
							</template>
						</div>
						<div class="mt-3 p-3 rounded-xl text-sm font-semibold" :class="sectionScore(si)>sec.max*0.5?'bg-red-50 text-red-700 border border-red-200':'bg-green-50 text-green-700 border border-green-200'">
							<span x-text="'Resultado: '+sectionScore(si)+' puntos'"></span>
						</div>
					</div>
				</template>
			</div>

			<!-- ===== SECTION 4: Interpretación ===== -->
			<div class="mb-10">
				<h2 class="section-title">4. Interpretación de Resultados</h2>
				<div class="bg-gray-50 p-6 rounded-3xl border border-gray-200 space-y-4">
					<!-- Scores por categoría -->
					<div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center text-sm mb-4">
						<template x-for="(sec, si) in sections" :key="'s'+si">
							<div class="bg-white p-3 rounded-xl border">
								<p class="text-xs text-gray-400" x-text="sec.title"></p>
								<p class="text-xl font-black" :class="sectionScore(si)>sec.max*0.5?'text-red-600':'text-green-600'" x-text="sectionScore(si)+'/'+sec.max"></p>
							</div>
						</template>
					</div>
					
					<div class="text-center">
						<p class="text-5xl font-black" :class="totalColor" x-text="totalScore()+'/51'"></p>
						<p class="text-lg font-bold mt-1" :class="totalColor" x-text="riskLevel()"></p>
						<p class="text-sm text-gray-500 mt-1" x-text="riskMeaning()"></p>
					</div>
					<div class="grid grid-cols-5 gap-2 text-center text-xs mt-4">
						<div class="p-2 rounded-xl" :class="totalScore()<=7?'bg-green-200 font-bold':'bg-green-50'">0-7<br/>Bajo</div>
						<div class="p-2 rounded-xl" :class="totalScore()>7&&totalScore()<=15?'bg-yellow-200 font-bold':'bg-yellow-50'">8-15<br/>Leve</div>
						<div class="p-2 rounded-xl" :class="totalScore()>15&&totalScore()<=24?'bg-orange-200 font-bold':'bg-orange-50'">16-24<br/>Moderado</div>
						<div class="p-2 rounded-xl" :class="totalScore()>24&&totalScore()<=35?'bg-red-200 font-bold':'bg-red-50'">25-35<br/>Alto</div>
						<div class="p-2 rounded-xl" :class="totalScore()>35?'bg-red-300 font-bold':'bg-red-50'">36-51<br/>Crítico</div>
					</div>
				</div>
			</div>

			<!-- Hidden fields para enviar scores -->
			<template x-for="(sec, si) in sections" :key="'h'+si">
				<input type="hidden" :name="'score_'+sec.key" :value="sectionScore(si)"/>
			</template>
			<input type="hidden" name="score_total" :value="totalScore()"/>
			<input type="hidden" name="nivel_riesgo" :value="riskLevel()"/>
			<input type="hidden" name="respuestas_json" :value="JSON.stringify(answers)"/>

			<div class="text-center mt-12">
				<button type="submit" class="bg-purple-600 text-white px-10 py-4 rounded-full font-bold text-xl shadow-lg hover:bg-purple-700 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 w-full md:w-auto">Guardar Evaluación</button>
			</div>
		</form>
	</main>
</Layout>

<script>
import Alpine from 'alpinejs';

window.formData = function() {
	return {
		// Dropdowns state
		pais:'',
		gradoEstudios:'', gradoEstudiosLabel:'Seleccione...',
		sexo:'', sexoLabel:'Seleccione...',
		gradoInstruccion:'', gradoInstruccionLabel:'Seleccione...',
		tipoTrabajo:'', tipoTrabajoLabel:'Seleccione...',
		nivelSocio:'', nivelSocioLabel:'Seleccione...',
		openDd: null,
		openRiskDd: null,
		toggleDd(n) { this.openDd = this.openDd===n ? null : n; },
		sel(f,v,l) { this[f]=v; this[f+'Label']=l; this.openDd=null; },

		// Scale options (text labels instead of numbers)
		scaleOptions: [
			{v:0,l:'Nunca'},{v:1,l:'A veces'},{v:2,l:'Con frecuencia'},{v:3,l:'Casi siempre'}
		],
		scaleLabelColors: {
			0:'text-green-700', 1:'text-yellow-600', 2:'text-orange-600', 3:'text-red-600'
		},
		scaleDotColors: {
			0:'bg-green-500', 1:'bg-yellow-500', 2:'bg-orange-500', 3:'bg-red-500'
		},

		sections: [
			{ key:'conducta', title:'Conducta de Juego', max:15,
			  questions:[
				'¿Has apostado más dinero del que podías permitirte perder?',
				'¿Necesitas apostar cantidades cada vez mayores para sentir la misma emoción?',
				'¿Has intentado dejar de jugar y no lo has logrado?',
				'¿Vuelves otro día para recuperar el dinero perdido?',
				'¿El juego ocupa gran parte de tus pensamientos?'
			  ]},
			{ key:'emocional', title:'Impacto Emocional', max:9,
			  questions:[
				'¿Te sientes inquieto o irritable cuando no puedes jugar?',
				'¿Usas el juego para escapar del estrés, tristeza o ansiedad?',
				'¿Después de perder, sientes urgencia por seguir apostando?'
			  ]},
			{ key:'economico', title:'Consecuencias Económicas', max:9,
			  questions:[
				'¿Has tomado dinero prestado para jugar?',
				'¿El juego ha afectado tu estabilidad financiera?',
				'¿Has ocultado pérdidas económicas?'
			  ]},
			{ key:'relaciones', title:'Relaciones y Vida Personal', max:9,
			  questions:[
				'¿Has mentido a tu familia o amigos sobre cuánto juegas?',
				'¿El juego ha generado discusiones o conflictos?',
				'¿Has descuidado responsabilidades por jugar?'
			  ]},
			{ key:'control', title:'Señales de Pérdida de Control', max:9,
			  questions:[
				'¿Sientes que el juego controla tus decisiones?',
				'¿Has intentado recuperar pérdidas con apuestas más grandes?',
				'¿Te cuesta parar incluso cuando sabes que deberías hacerlo?'
			  ]}
		],

		// Initialize all answers to -1 (unselected)
		answers: [
			[-1,-1,-1,-1,-1],
			[-1,-1,-1],
			[-1,-1,-1],
			[-1,-1,-1],
			[-1,-1,-1]
		],

		sectionScore(i) { return this.answers[i].reduce((a,b)=>a+(b<0?0:b), 0); },
		totalScore() { return this.answers.flat().reduce((a,b)=>a+(b<0?0:b), 0); },
		get totalColor() {
			const t=this.totalScore();
			if(t<=7) return 'text-green-600'; if(t<=15) return 'text-yellow-600';
			if(t<=24) return 'text-orange-600'; if(t<=35) return 'text-red-600'; return 'text-red-800';
		},
		riskLevel() {
			const t=this.totalScore();
			if(t<=7) return 'Bajo'; if(t<=15) return 'Riesgo leve';
			if(t<=24) return 'Riesgo moderado'; if(t<=35) return 'Alto'; return 'Crítico';
		},
		riskMeaning() {
			const t=this.totalScore();
			if(t<=7) return 'Conducta recreativa'; if(t<=15) return 'Atención temprana recomendable';
			if(t<=24) return 'Posible juego problemático'; if(t<=35) return 'Pérdida de control emergente'; return 'Alta probabilidad de trastorno';
		},
		submitForm() {
			const hasEmpty = this.answers.flat().some(a => a < 0);
			if(hasEmpty) { alert('Por favor, responda todas las preguntas del cuestionario.'); return; }
			const form = document.getElementById('ludopatia-form');
			form.submit();
		}
	};
};

window.Alpine = Alpine;
Alpine.start();
</script>

<style>
	[x-cloak] { display: none !important; }
	.section-title { font-size:1.25rem; font-weight:700; background:#E9D5FF; display:inline-block; padding:.5rem 1rem; margin-bottom:1.5rem; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.05); color:#6B21A8; }
	.field-label { display:block; font-size:.875rem; font-weight:600; margin-bottom:.5rem; color:#374151; }
	.cs-input { width:100%; border:1px solid #D1D5DB; border-radius:1rem; padding:.75rem 1rem; box-shadow:0 1px 2px rgba(0,0,0,.05); outline:none; transition:all .2s; }
	.cs-input:focus { border-color:#9333EA; box-shadow:0 0 0 3px rgba(147,51,234,.15); }
	.cs-trigger { width:100%; display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; background:#fff; border:1px solid #D1D5DB; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.05); cursor:pointer; transition:all .2s; text-align:left; font-size:.95rem; }
	.cs-trigger:hover { border-color:#C084FC; }
	.cs-trigger-active { border-color:#9333EA; box-shadow:0 0 0 3px rgba(147,51,234,.15); border-bottom-left-radius:0; border-bottom-right-radius:0; }
	.cs-arrow { width:1.25rem; height:1.25rem; color:#9CA3AF; transition:transform .3s cubic-bezier(.4,0,.2,1); flex-shrink:0; }
	.cs-list { position:absolute; top:100%; left:0; right:0; z-index:50; background:#fff; border:1px solid #9333EA; border-top:none; border-bottom-left-radius:1rem; border-bottom-right-radius:1rem; box-shadow:0 10px 25px rgba(0,0,0,.1); max-height:0; overflow:hidden; opacity:0; transform:translateY(-4px); transition:max-height .35s cubic-bezier(.4,0,.2,1),opacity .25s ease,transform .25s ease; }
	.cs-list-open { max-height:300px; opacity:1; transform:translateY(0); overflow-y:auto; }
	.cs-option { padding:.7rem 1rem; cursor:pointer; transition:background .15s; font-size:.95rem; border-bottom:1px solid #f1f5f9; }
	.cs-option:last-child { border-bottom:none; }
	.cs-option:hover { background:#F3E8FF; color:#7C3AED; }
</style>
