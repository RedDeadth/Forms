---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import { pool } from '../../db.js';

if (!Astro.cookies.has('admin_auth')) {
    return Astro.redirect('/');
}

let stats = { total: 0, bajo: 0, leve: 0, moderado: 0, alto: 0, critico: 0, avgScore: 0 };
let evaluaciones = [];

try {
    const [rows] = await pool.query('SELECT * FROM evaluaciones ORDER BY created_at DESC LIMIT 50');
    evaluaciones = rows;
    stats.total = rows.length;
    stats.bajo = rows.filter(r => r.nivel_riesgo === 'Bajo').length;
    stats.leve = rows.filter(r => r.nivel_riesgo === 'Riesgo leve').length;
    stats.moderado = rows.filter(r => r.nivel_riesgo === 'Riesgo moderado').length;
    stats.alto = rows.filter(r => r.nivel_riesgo === 'Alto').length;
    stats.critico = rows.filter(r => r.nivel_riesgo === 'Crítico').length;
    stats.avgScore = rows.length ? Math.round(rows.reduce((a, r) => a + (r.score_total || 0), 0) / rows.length) : 0;
} catch (e) {
    console.error('Dashboard DB error:', e);
}
---

<Layout>
	<main class="min-h-screen p-6" x-data="{ search: '', expandedRow: null }">
        
        <div class="max-w-7xl mx-auto mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-extrabold text-purple-700">Panel de Administrador</h1>
                <p class="text-gray-500 mt-1">Resumen de evaluaciones de ludopatía</p>
            </div>
            <a href="/api/logout" class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-red-600 transition text-sm">Cerrar Sesión</a>
        </div>

        <!-- Stats -->
        <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-7 gap-3 mb-8">
            <div class="bg-white rounded-2xl p-4 shadow-md border text-center">
                <p class="text-3xl font-black text-purple-600">{stats.total}</p>
                <p class="text-xs text-gray-500 mt-1">Total</p>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-md border text-center">
                <p class="text-3xl font-black text-purple-500">{stats.avgScore}</p>
                <p class="text-xs text-gray-500 mt-1">Puntaje Prom.</p>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-md border text-center">
                <p class="text-3xl font-black text-green-600">{stats.bajo}</p>
                <p class="text-xs text-gray-500 mt-1">Bajo</p>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-md border text-center">
                <p class="text-3xl font-black text-yellow-500">{stats.leve}</p>
                <p class="text-xs text-gray-500 mt-1">Leve</p>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-md border text-center">
                <p class="text-3xl font-black text-orange-600">{stats.moderado}</p>
                <p class="text-xs text-gray-500 mt-1">Moderado</p>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-md border text-center">
                <p class="text-3xl font-black text-red-600">{stats.alto}</p>
                <p class="text-xs text-gray-500 mt-1">Alto</p>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-md border text-center">
                <p class="text-3xl font-black text-red-800">{stats.critico}</p>
                <p class="text-xs text-gray-500 mt-1">Crítico</p>
            </div>
        </div>

        <!-- Search -->
        <div class="max-w-7xl mx-auto mb-6">
            <input type="text" x-model="search" placeholder="Buscar por evaluador, provincia o país..." class="w-full md:w-96 border border-gray-300 rounded-xl px-4 py-2 shadow-sm focus:ring focus:ring-purple-200 outline-none"/>
        </div>

        <!-- Table -->
        <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-3 py-3 text-left font-semibold text-gray-600">#</th>
                            <th class="px-3 py-3 text-left font-semibold text-gray-600">Evaluador</th>
                            <th class="px-3 py-3 text-left font-semibold text-gray-600">Sexo</th>
                            <th class="px-3 py-3 text-center font-semibold text-gray-600">Edad</th>
                            <th class="px-3 py-3 text-left font-semibold text-gray-600">Instrucción</th>
                            <th class="px-3 py-3 text-left font-semibold text-gray-600">Trabajo</th>
                            <th class="px-3 py-3 text-center font-semibold text-gray-600">NSE</th>
                            <th class="px-3 py-3 text-left font-semibold text-gray-600">País</th>
                            <th class="px-3 py-3 text-center font-semibold text-gray-600">Total</th>
                            <th class="px-3 py-3 text-center font-semibold text-gray-600">Nivel</th>
                            <th class="px-3 py-3 text-left font-semibold text-gray-600">Fecha</th>
                            <th class="px-3 py-3 text-center font-semibold text-gray-600">Detalle</th>
                        </tr>
                    </thead>
                    <tbody>
                        {evaluaciones.map((r, i) => {
                            const lc = r.nivel_riesgo === 'Bajo' ? 'bg-green-100 text-green-700' 
                                : r.nivel_riesgo === 'Riesgo leve' ? 'bg-yellow-100 text-yellow-700'
                                : r.nivel_riesgo === 'Riesgo moderado' ? 'bg-orange-100 text-orange-700'
                                : r.nivel_riesgo === 'Alto' ? 'bg-red-100 text-red-700'
                                : 'bg-red-200 text-red-800';
                            const searchStr = `${(r.evaluador_nombre||'').toLowerCase()} ${(r.provincia||'').toLowerCase()} ${(r.pais||'').toLowerCase()}`;
                            return (
                                <>
                                <tr class="border-b hover:bg-purple-50 transition cursor-pointer"
                                    x-show={`'${searchStr}'.includes(search.toLowerCase()) || search===''`}
                                    x-on:click={`expandedRow = expandedRow===${i} ? null : ${i}`}>
                                    <td class="px-3 py-3 text-gray-400">{i + 1}</td>
                                    <td class="px-3 py-3 font-medium">{r.evaluador_nombre}</td>
                                    <td class="px-3 py-3">{r.sexo || '-'}</td>
                                    <td class="px-3 py-3 text-center">{r.edad || '-'}</td>
                                    <td class="px-3 py-3">{r.grado_instruccion || '-'}</td>
                                    <td class="px-3 py-3">{r.tipo_trabajo || '-'}</td>
                                    <td class="px-3 py-3 text-center font-bold">{r.nivel_socioeconomico || '-'}</td>
                                    <td class="px-3 py-3">{r.pais || '-'}</td>
                                    <td class="px-3 py-3 text-center font-bold">{r.score_total}</td>
                                    <td class="px-3 py-3 text-center"><span class={`px-2 py-1 rounded-lg text-xs font-bold ${lc}`}>{r.nivel_riesgo}</span></td>
                                    <td class="px-3 py-3 text-gray-400 text-xs">{r.fecha || new Date(r.created_at).toLocaleDateString('es')}</td>
                                    <td class="px-3 py-3 text-center text-purple-500">
                                        <span x-text={`expandedRow===${i}?'▲':'▼'`}></span>
                                    </td>
                                </tr>
                                <tr x-show={`expandedRow===${i}`} x-transition class="border-b bg-purple-50">
                                    <td colspan="12" class="px-6 py-4">
                                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                                            <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Conducta</p><p class="font-bold">{r.score_conducta}/15</p></div>
                                            <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Emocional</p><p class="font-bold">{r.score_emocional}/9</p></div>
                                            <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Económico</p><p class="font-bold">{r.score_economico}/9</p></div>
                                            <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Relaciones</p><p class="font-bold">{r.score_relaciones}/9</p></div>
                                            <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Control</p><p class="font-bold">{r.score_control}/9</p></div>
                                        </div>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mt-3">
                                            <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Región</p><p class="font-medium">{r.region || '-'}</p></div>
                                            <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Provincia</p><p class="font-medium">{r.provincia || '-'}</p></div>
                                            <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Estudios Evaluador</p><p class="font-medium">{r.grado_estudios_evaluador || '-'}</p></div>
                                            <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">NSE</p><p class="font-medium">{r.nivel_socioeconomico || '-'}</p></div>
                                        </div>
                                    </td>
                                </tr>
                                </>
                            );
                        })}
                    </tbody>
                </table>
            </div>
            {evaluaciones.length === 0 && <p class="text-center py-10 text-gray-400">No hay evaluaciones registradas aún.</p>}
        </div>
	</main>
</Layout>

<script>
import Alpine from 'alpinejs';
window.Alpine = Alpine;
Alpine.start();
</script>
