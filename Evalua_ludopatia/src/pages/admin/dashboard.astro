---
import Layout from '../../layouts/Layout.astro';
---
<Layout>
	<main class="min-h-screen p-6" x-data="dashboardData()">
        <div x-show="loading" class="flex items-center justify-center min-h-[50vh]">
            <div class="text-center"><div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-4"></div><p class="text-gray-500 font-medium">Cargando datos...</p></div>
        </div>
        <div x-show="!loading && !authorized" class="flex items-center justify-center min-h-[50vh]">
            <div class="text-center bg-white p-10 rounded-3xl shadow-xl border"><p class="text-xl font-bold text-red-600 mb-4">⚠️ No autorizado</p><a href="/" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-purple-700 transition">Ir al inicio</a></div>
        </div>
        <div x-show="!loading && authorized" x-cloak>
            <div class="max-w-7xl mx-auto mb-8 flex justify-between items-end">
                <div><h1 class="text-3xl font-extrabold text-purple-700">Panel de Administrador</h1><p class="text-gray-500 mt-1">Resumen de evaluaciones de ludopatía</p></div>
                <a href="/api/logout.php" class="bg-red-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-red-600 transition text-sm">Cerrar Sesión</a>
            </div>
            <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-purple-600" x-text="stats.total"></p><p class="text-xs text-gray-500 mt-1">Total</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-purple-500" x-text="stats.avgScore"></p><p class="text-xs text-gray-500 mt-1">Puntaje Prom.</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-green-600" x-text="stats.bajo"></p><p class="text-xs text-gray-500 mt-1">Bajo</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-yellow-600" x-text="stats.leve"></p><p class="text-xs text-gray-500 mt-1">Leve</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-orange-600" x-text="stats.moderado+stats.alto"></p><p class="text-xs text-gray-500 mt-1">Mod./Alto</p></div>
                <div class="bg-white rounded-2xl p-5 shadow-md border text-center"><p class="text-3xl font-black text-red-600" x-text="stats.critico"></p><p class="text-xs text-gray-500 mt-1">Crítico</p></div>
            </div>
            <div class="max-w-7xl mx-auto mb-6"><input type="text" x-model="search" placeholder="Buscar por evaluador, país..." class="w-full md:w-96 border border-gray-300 rounded-xl px-4 py-2 shadow-sm focus:ring focus:ring-purple-200 outline-none"/></div>
            <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">#</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">Evaluador</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">Sexo</th>
                                <th class="px-3 py-3 text-center font-semibold text-gray-600">Edad</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">País</th>
                                <th class="px-3 py-3 text-center font-semibold text-gray-600">Total</th>
                                <th class="px-3 py-3 text-center font-semibold text-gray-600">Nivel</th>
                                <th class="px-3 py-3 text-left font-semibold text-gray-600">Fecha</th>
                                <th class="px-3 py-3 text-center font-semibold text-gray-600">Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(r, i) in filtered()" :key="i">
                                <tr>
                                    <td colspan="9" class="p-0">
                                        <div class="flex items-center border-b hover:bg-purple-50 transition cursor-pointer" @click="exp = exp===i ? null : i">
                                            <div class="px-3 py-3 text-gray-400 w-[40px]" x-text="i+1"></div>
                                            <div class="px-3 py-3 font-medium flex-1" x-text="r.evaluador_nombre||'-'"></div>
                                            <div class="px-3 py-3 w-[70px]" x-text="r.sexo||'-'"></div>
                                            <div class="px-3 py-3 text-center w-[50px]" x-text="r.edad||'-'"></div>
                                            <div class="px-3 py-3 w-[80px]" x-text="r.pais||'-'"></div>
                                            <div class="px-3 py-3 text-center font-bold w-[60px]" x-text="r.score_total+'/51'"></div>
                                            <div class="px-3 py-3 text-center w-[120px]"><span class="px-2 py-1 rounded-lg text-xs font-bold" :class="lvlClass(r.nivel_riesgo)" x-text="r.nivel_riesgo"></span></div>
                                            <div class="px-3 py-3 text-gray-400 text-xs w-[80px]" x-text="r.created_at?new Date(r.created_at).toLocaleDateString('es'):r.fecha||'-'"></div>
                                            <div class="px-3 py-3 text-center text-purple-500 w-[40px]"><span x-text="exp===i?'▲':'▼'"></span></div>
                                        </div>
                                        <div x-show="exp===i" x-transition class="bg-purple-50/50 px-6 py-4 border-b">
                                            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Conducta</p><p class="font-bold" x-text="r.score_conducta+'/15'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Emocional</p><p class="font-bold" x-text="r.score_emocional+'/9'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Económico</p><p class="font-bold" x-text="r.score_economico+'/9'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Relaciones</p><p class="font-bold" x-text="r.score_relaciones+'/9'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Control</p><p class="font-bold" x-text="r.score_control+'/9'"></p></div>
                                            </div>
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mt-3">
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Región/Prov.</p><p class="font-medium" x-text="(r.region||'-')+' / '+(r.provincia||'-')"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Instrucción</p><p class="font-medium" x-text="r.grado_instruccion||'-'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Trabajo</p><p class="font-medium" x-text="r.tipo_trabajo||'-'"></p></div>
                                                <div class="bg-white p-3 rounded-xl border"><p class="text-xs text-gray-400">Nivel Socioe.</p><p class="font-medium" x-text="r.nivel_socioeconomico||'-'"></p></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <p x-show="data.length===0&&!loading" class="text-center py-10 text-gray-400">No hay evaluaciones registradas aún.</p>
            </div>
        </div>
	</main>
</Layout>
<script>
import Alpine from 'alpinejs';
window.dashboardData = function() {
    return {
        loading: true, authorized: false, search: '', exp: null,
        stats: {total:0,bajo:0,leve:0,moderado:0,alto:0,critico:0,avgScore:0}, data: [],
        async init() {
            if (!document.cookie.includes('admin_auth=true')) { this.loading=false; return; }
            try {
                const res = await fetch('/api/get_evaluaciones.php');
                if (res.status===401) { this.loading=false; return; }
                const d = await res.json(); this.stats=d.stats; this.data=d.evaluaciones; this.authorized=true;
            } catch(e) { console.error(e); }
            this.loading=false;
        },
        filtered() { if(!this.search) return this.data; const s=this.search.toLowerCase(); return this.data.filter(r=>`${r.evaluador_nombre||''} ${r.pais||''}`.toLowerCase().includes(s)); },
        lvlClass(n) { return n==='Bajo'?'bg-green-100 text-green-700':n==='Riesgo leve'?'bg-yellow-100 text-yellow-700':n==='Riesgo moderado'?'bg-orange-100 text-orange-700':'bg-red-100 text-red-700'; }
    };
};
window.Alpine = Alpine; Alpine.start();
</script>
<style>[x-cloak] { display: none !important; }</style>
